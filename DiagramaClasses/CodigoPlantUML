@startuml

skinparam classAttributeIconSize 0
skinparam linetype ortho

package "Domain Entities" {
    abstract class Usuario {
        - UUID id
        - String nome
        - String email
        - String senha
        - String telefone
        - String documento
        - RoleUsuario role
        - TipoNotificacao preferenciaNotificacao
        + {abstract} podeAnunciar(): boolean
        + getters/setters()
    }

    class Proprietario extends Usuario {
        + podeAnunciar(): boolean
    }

    class Corretor extends Usuario {
        - String creci
        - Double percentualComissao
        + podeAnunciar(): boolean
    }

    class Interessado extends Usuario {
        + podeAnunciar(): boolean
    }

    enum RoleUsuario {
        ANUNCIANTE
        COMUM
    }

    enum TipoNotificacao {
        EMAIL
        SMS
        WHATSAPP
    }
}

package "Domain Imovel" {
    interface Prototype<T> {
        + clone() : T
    }
    abstract class Imovel implements Prototype<Imovel> {
        - id : UUID
        - endereco : Endereco
        - areaMetrosQuadrados : Double
        - numeroQuartos : Integer
        - numeroBanheiros : Integer
        - descricao : String
        + Imovel()
        + Imovel(endereco : Endereco, areaMetrosQuadrados : Double, numeroQuartos : Integer, numeroBanheiros : Integer, descricao : String)
        + Imovel(imovelTarget : Imovel)
        + {abstract} clone() : Imovel
        + {abstract} getTipoImovel() : String
        + getters/setters()
    }
    class Casa extends Imovel {
        - possuiQuintal : boolean
        - possuiPiscina : boolean
        - vagasGaragem : int
        + Casa()
        + Casa(endereco : Endereco, areaMetrosQuadrados : Double, numeroQuartos : Integer, numeroBanheiros : Integer, descricao : String, possuiQuintal : boolean, possuiPiscina : boolean, vagasGaragem : int)
        + Casa(target : Casa)
        + clone() : Imovel
        + getTipoImovel() : String
        + getters/setters()
    }
    class Apartamento extends Imovel {
        - andar : int
        - possuiElevador : boolean
        - portaria24h : boolean
        - valorCondominio : Double
        + Apartamento()
        + Apartamento(endereco : Endereco, areaMetrosQuadrados : Double, numeroQuartos : Integer, numeroBanheiros : Integer, descricao : String, andar : int, possuiElevador : boolean, portaria24h : boolean, valorCondominio : Double)
        + Apartamento(target : Apartamento)
        + clone() : Imovel
        + getTipoImovel() : String
        + getters/setters()
    }
    class Terreno extends Imovel {
        - ehMurado : boolean
        - topografia : String
        + Terreno(endereco : Endereco, areaMetrosQuadrados : Double, numeroQuartos : Integer, numeroBanheiros : Integer, descricao : String, ehMurado : boolean, topografia : String)
        + Terreno(target : Terreno)
        + clone() : Imovel
        + getTipoImovel() : String
        + getters/setters()
    }
    class Endereco {
        - rua : String
        - bairro : String
        - cidade : String
        - estado : String
        + Endereco()
        + Endereco(rua : String, bairro : String, cidade : String, estado : String)
        + getters/setters()
    }
}

package "Domain Anuncio" {
    class Anuncio {
        - UUID id
        - String titulo
        - BigDecimal valor
        - LocalDateTime dataCriacao
        - TipoAnuncio tipoAnuncio
        - EstadoAnuncio estadoAtual
        - Imovel imovel
        - Usuario anunciante
        - List<AnuncioObserver> observers
        + addObserver(AnuncioObserver): void
        + mudarEstadoAnuncio(EstadoAnuncio): void
        + submeterAModeracao(): void
        + aprovarModeracao(): void
        + reprovarModeracao(): void
        + venderAnuncio(): void
        + suspenderAnuncio(): void
        + jaEstaPublicado(): void
    }

    enum TipoAnuncio {
        VENDA
        ALUGUEL
        TEMPORADA
    }

    Anuncio --> "1" Imovel
    Anuncio --> "1" Usuario : anunciante
}

package "Pattern State" {

    abstract class EstadoAnuncio {
        + enviarParaModeracao(anuncio : Anuncio) : void
        + aprovar(anuncio : Anuncio) : void
        + reprovar(anuncio : Anuncio) : void
        + vender(anuncio : Anuncio) : void
        + suspender(anuncio : Anuncio) : void
        + jaEstaPublicado() : boolean
        + {abstract} getNomeEstado() : String
    }

    class EstadoRascunho {
        + enviarParaModeracao(anuncio : Anuncio) : void
        + getNomeEstado() : String
    }

    class EstadoModeracao {
        + aprovar(anuncio : Anuncio) : void
        + reprovar(anuncio : Anuncio) : void
        + getNomeEstado() : String
    }

    class EstadoAtivo {
        + vender(anuncio : Anuncio) : void
        + suspender(anuncio : Anuncio) : void
        + jaEstaPublicado() : boolean
        + getNomeEstado() : String
    }

    class EstadoVendido {
        + jaEstaPublicado() : boolean
        + getNomeEstado() : String
    }

    class EstadoSuspenso {
        + getNomeEstado() : String
    }

    EstadoAnuncio <|-- EstadoRascunho
    EstadoAnuncio <|-- EstadoModeracao
    EstadoAnuncio <|-- EstadoAtivo
    EstadoAnuncio <|-- EstadoVendido
    EstadoAnuncio <|-- EstadoSuspenso

    Anuncio --> "1" EstadoAnuncio : estadoAtual
}

package "Pattern Observer & Strategy" {
    interface AnuncioObserver {
        + onEstadoAlterado(anuncio : Anuncio, estadoAnterior : String, estadoAtual : String) : void
    }

    class NotificacaoAnuncioObserver implements AnuncioObserver {
        - estrategias : Map<TipoNotificacao, NotificacaoStrategy>
        + NotificacaoAnuncioObserver(estrategias : Map<TipoNotificacao, NotificacaoStrategy>)
        + onEstadoAlterado(anuncio : Anuncio, estadoAnterior : String, estadoAtual : String) : void
    }

    abstract class NotificacaoStrategy {
        # logService : NotificacaoLogService
        + NotificacaoStrategy(logService : NotificacaoLogService)
        + setEstrategia(logService : NotificacaoLogService) : void
        + {abstract} enviar(destinatario : Usuario, titulo : String, mensagem : String) : void
    }

    class EmailNotificacaoStrategy {
        + EmailNotificacaoStrategy(logService : NotificacaoLogService)
        + enviar(destinatario : Usuario, titulo : String, mensagem : String) : void
    }

    class NotificacaoLogService {
        - filePath : String
        + NotificacaoLogService(filePath : String)
        + registrarEnvio(canal : String, destinatario : Usuario, titulo : String, mensagem : String) : void
    }

    Anuncio o-- "*" AnuncioObserver
    NotificacaoAnuncioObserver --> "1..*" NotificacaoStrategy : usa
    EmailNotificacaoStrategy -left-|> NotificacaoStrategy
    NotificacaoStrategy --> NotificacaoLogService
}

package "Pattern Factory" {
    abstract class ImovelFactory {
        + {abstract} criarImovel(dados : Map<String, Object>) : Imovel
    }
    class CasaFactory {
        + criarImovel(dados : Map<String, Object>) : Imovel
    }
    class ApartamentoFactory {
        + criarImovel(dados : Map<String, Object>) : Imovel
    }
    class TerrenoFactory {
        + criarImovel(dados : Map<String, Object>) : Imovel
    }

    ImovelFactory <|-- CasaFactory
    ImovelFactory <|-- ApartamentoFactory
    ImovelFactory <|-- TerrenoFactory
}

package "Pattern Prototype" {
    class AnuncioPrototypeRegistry {
        - prototipos : Map<String, Imovel>
        + AnuncioPrototypeRegistry()
        + obterClone(chave : String) : Imovel
    }

    AnuncioPrototypeRegistry --> "*" Imovel : prototipos
}

package "Pattern Decorator (Busca)" {
    interface IBuscaAnuncio {
        + executar() : List<Anuncio>
    }
    class BuscaTodosAnuncios implements IBuscaAnuncio {
        - repository : AnuncioRepository
        + BuscaTodosAnuncios(repository : AnuncioRepository)
        + executar() : List<Anuncio>
    }
    abstract class FiltroBaseDecorator implements IBuscaAnuncio {
        # buscaDecorada : IBuscaAnuncio
        + FiltroBaseDecorator(buscaDecorada : IBuscaAnuncio)
        + executar() : List<Anuncio>
    }
    class FiltroCidade {
        - cidadeAlvo : String
        + FiltroCidade(buscaDecorada : IBuscaAnuncio, cidadeAlvo : String)
        + executar() : List<Anuncio>
    }
    class FiltroTipoImovel {
        - tipoAlvo : String
        + FiltroTipoImovel(buscaDecorada : IBuscaAnuncio, tipoAlvo : String)
        + executar() : List<Anuncio>
    }
    class FiltroPrecoMaximo {
        - valorMaximo : BigDecimal
        + FiltroPrecoMaximo(buscaDecorada : IBuscaAnuncio, valorMaximo : BigDecimal)
        + executar() : List<Anuncio>
    }
    class FiltroFactory {
        + {static} criar(tipoFiltro : String, buscaAtual : IBuscaAnuncio, valor : Object) : IBuscaAnuncio
    }

    FiltroBaseDecorator <|-- FiltroCidade
    FiltroBaseDecorator <|-- FiltroTipoImovel
    FiltroBaseDecorator <|-- FiltroPrecoMaximo
}

package "Pattern Chain of Responsibility" {
    interface ModeracaoHandler {
        + setNext(handler : ModeracaoHandler) : void
        + handle(anuncio : Anuncio) : void
    }
    class BaseModeracaoHandler implements ModeracaoHandler {
        - next : ModeracaoHandler
        + setNext(handler : ModeracaoHandler) : void
        + handle(anuncio : Anuncio) : void
    }
    class ValidadorPreco {
        + handle(anuncio : Anuncio) : void
    }
    class ValidadorTexto {
        + handle(anuncio : Anuncio) : void
    }
    class ValidadorDescricao {
        + handle(anuncio : Anuncio) : void
    }

    BaseModeracaoHandler <|-- ValidadorPreco
    BaseModeracaoHandler <|-- ValidadorTexto
    BaseModeracaoHandler <|-- ValidadorDescricao
}

package "Repositories" {
    class BancoDeDados <<Singleton>> {
        - tabelaAnuncios : List<Anuncio>
        - tabelaUsuarios : List<Usuario>
        - BancoDeDados()
        + {static} getInstance() : BancoDeDados
        + getTabelaAnuncios() : List<Anuncio>
        + getTabelaUsuarios() : List<Usuario>
    }
    class UsuarioRepository {
        - db : BancoDeDados
        + salvar(usuario : Usuario) : void
        + deletar(usuario : Usuario) : void
        + listarTodos() : List<Usuario>
        + buscarPorEmail(email : String) : Usuario
    }
    class AnuncioRepository {
        - db : BancoDeDados
        + salvar(anuncio : Anuncio) : void
        + deletar(anuncio : Anuncio) : void
        + buscarPorAnunciante(idAnunciante : UUID) : List<Anuncio>
        + listarTodos() : List<Anuncio>
    }

    UsuarioRepository --> BancoDeDados
    AnuncioRepository --> BancoDeDados
}

package "Services / UseCases" {
    interface ICriarAnuncioUseCase {
        + execute(usuario : Usuario, titulo : String, valor : BigDecimal, tipoAnuncio : TipoAnuncio, tipoImovel : String, dadosImovel : Map<String, Object>) : Anuncio
    }
    class CriarAnuncioUseCase implements ICriarAnuncioUseCase {
        - anuncioRepository : AnuncioRepository
        - anuncioObserver : AnuncioObserver
        + CriarAnuncioUseCase(anuncioRepository : AnuncioRepository, anuncioObserver : AnuncioObserver)
        + execute(usuario : Usuario, titulo : String, valor : BigDecimal, tipoAnuncio : TipoAnuncio, tipoImovel : String, dadosImovel : Map<String, Object>) : Anuncio
    }

    CriarAnuncioUseCase ..> ImovelFactory : uses

    interface ICriarAnuncioPadraoUseCase {
        + execute(usuario : Usuario, titulo : String, valor : BigDecimal, tipoAnuncio : TipoAnuncio, endereco : Endereco, chaveTemplateImovel : String) : Anuncio
    }
    class CriarAnuncioPadraoUseCase implements ICriarAnuncioPadraoUseCase {
        - repository : AnuncioRepository
        - registry : AnuncioPrototypeRegistry
        - anuncioObserver : AnuncioObserver
        + CriarAnuncioPadraoUseCase(repository : AnuncioRepository, anuncioObserver : AnuncioObserver)
        + execute(usuario : Usuario, titulo : String, valor : BigDecimal, tipoAnuncio : TipoAnuncio, endereco : Endereco, chaveTemplateImovel : String) : Anuncio
    }

    interface IBuscarAnunciosUseCase {
        + execute(filtrosUsuario : Map<String, Object>) : List<Anuncio>
    }
    class BuscarAnunciosUseCase implements IBuscarAnunciosUseCase {
        - repository : AnuncioRepository
        + BuscarAnunciosUseCase(repository : AnuncioRepository)
        + execute(filtrosUsuario : Map<String, Object>) : List<Anuncio>
    }

    BuscarAnunciosUseCase ..> FiltroFactory : uses

    interface ISubmeterAnuncioUseCase {
        + execute(anuncio : Anuncio) : String
    }
    class SubmeterAnuncioUseCase implements ISubmeterAnuncioUseCase {
        + SubmeterAnuncioUseCase()
        + execute(anuncio : Anuncio) : String
    }

    SubmeterAnuncioUseCase ..> ModeracaoHandler : chains

    interface IRealizarLoginUseCase {
        + execute(email : String, senha : String) : Usuario
    }
    class RealizarLoginUseCase implements IRealizarLoginUseCase {
        - usuarioRepository : UsuarioRepository
        + RealizarLoginUseCase(usuarioRepository : UsuarioRepository)
        + execute(email : String, senha : String) : Usuario
    }

    interface IListarMeusAnunciosUseCase {
        + execute(usuario : Usuario) : List<Anuncio>
    }
    class ListarMeusAnunciosUseCase implements IListarMeusAnunciosUseCase {
        - repository : AnuncioRepository
        + ListarMeusAnunciosUseCase(repository : AnuncioRepository)
        + execute(usuario : Usuario) : List<Anuncio>
    }

    CriarAnuncioUseCase --> AnuncioRepository
    CriarAnuncioPadraoUseCase --> AnuncioRepository
    BuscarAnunciosUseCase --> AnuncioRepository
    ListarMeusAnunciosUseCase --> AnuncioRepository
    RealizarLoginUseCase --> UsuarioRepository
}

package "Controller & View" {
    class ConsoleUI {
        + ConsoleUI()
        + mostrarMensagem(mensagem : String) : void
        + mostrarErro(erro : String) : void
        + limparTela() : void
        + lerTexto(prompt : String) : String
        + lerTextoObrigatorio(prompt : String) : String
        + lerDecimal(prompt : String) : Double
        + lerInteiro(prompt : String) : Integer
        + lerBooleano(prompt : String) : Boolean
        + lerEndereco() : Endereco
        + coletarDadosImovel(tipoImovel : String) : Map<String, Object>
    }

    class MenuController {
        - ui : ConsoleUI
        - usuarioLogado : Usuario
        - criarAnuncioUseCase : ICriarAnuncioUseCase
        - criarAnuncioPadraoUseCase : ICriarAnuncioPadraoUseCase
        - listarMeusAnunciosUseCase : IListarMeusAnunciosUseCase
        - buscarAnunciosUseCase : IBuscarAnunciosUseCase
        - submeterAnuncioUseCase : ISubmeterAnuncioUseCase

        + MenuController(ui : ConsoleUI, usuarioLogado : Usuario, criarAnuncioUseCase : ICriarAnuncioUseCase, criarAnuncioPadraoUseCase : ICriarAnuncioPadraoUseCase, listarMeusAnunciosUseCase : IListarMeusAnunciosUseCase, buscarAnunciosUseCase : IBuscarAnunciosUseCase, submeterAnuncioUseCase : ISubmeterAnuncioUseCase)
        + iniciar() : void
        - fluxoBuscar() : void
        - fluxoSubmeterAnuncio() : void
        - fluxoMenuCriacao() : void
        - fluxoListarMeusAnuncios() : void
        - fluxoCriarAnuncioManual() : void
        - fluxoCriarPadrao() : void
    }

    MenuController --> ConsoleUI
    MenuController --> ICriarAnuncioUseCase
    MenuController --> ICriarAnuncioPadraoUseCase
    MenuController --> IListarMeusAnunciosUseCase
    MenuController --> IBuscarAnunciosUseCase
    MenuController --> ISubmeterAnuncioUseCase
}

Imovel *-- Endereco
Usuario -right-> RoleUsuario
Usuario -right-> TipoNotificacao
Anuncio --> TipoAnuncio

@enduml